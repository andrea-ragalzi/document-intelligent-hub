name: Quality Gate Check

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches-ignore:
      - main

jobs:
  backend-quality-gate:
    name: Backend Quality Gate (Python/FastAPI)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run Pylint (PEP 8 Enforcement)
        run: |
          poetry run pylint app/ --rcfile=.pylintrc --fail-under=9.0 --exit-zero > pylint-report.txt
          PYLINT_SCORE=$(poetry run pylint app/ --rcfile=.pylintrc --fail-under=9.0 | grep "Your code has been rated at" | awk '{print $7}' | cut -d'/' -f1)
          echo "Pylint Score: $PYLINT_SCORE"
          if (( $(echo "$PYLINT_SCORE < 9.0" | bc -l) )); then
            echo "❌ Pylint failed: Score $PYLINT_SCORE is below 9.0"
            cat pylint-report.txt
            exit 1
          fi
          echo "✅ Pylint passed with score: $PYLINT_SCORE"

      - name: Run Mypy (Type Checking)
        run: |
          poetry run mypy app/ --strict --pretty
          if [ $? -ne 0 ]; then
            echo "❌ Mypy type checking failed: Type errors detected"
            exit 1
          fi
          echo "✅ Mypy type checking passed (strict mode)"

      - name: Run Lizard (Complexity Check)
        run: |
          poetry run lizard app/ -l python -C 15 -w -o lizard-report.txt
          if [ $? -ne 0 ]; then
            echo "❌ Lizard complexity check failed: Functions exceed CCN threshold of 15"
            cat lizard-report.txt
            exit 1
          fi
          echo "✅ Lizard complexity check passed (CCN ≤ 15)"

      - name: Run Pytest with Coverage
        run: |
          poetry run pytest --cov=app --cov-report=term --cov-report=xml --cov-fail-under=80 -v
          if [ $? -ne 0 ]; then
            echo "❌ Tests failed or coverage below 80%"
            exit 1
          fi
          echo "✅ All tests passed with coverage ≥ 80%"

      - name: Upload Backend Coverage Report
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  frontend-quality-gate:
    name: Frontend Quality Gate (TypeScript/Next.js)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (Quality & Style Check)
        run: |
          npm run lint -- --max-warnings=0
          if [ $? -ne 0 ]; then
            echo "❌ ESLint failed: Critical errors or warnings found"
            exit 1
          fi
          echo "✅ ESLint passed with zero errors/warnings"

      - name: Run TypeScript Type Check
        run: |
          npx tsc --noEmit --pretty
          if [ $? -ne 0 ]; then
            echo "❌ TypeScript compilation failed: Type errors detected"
            exit 1
          fi
          echo "✅ TypeScript type check passed"

      - name: Run Prettier Format Check
        run: |
          npx prettier --check "**/*.{ts,tsx,js,jsx,json,css,md}"
          if [ $? -ne 0 ]; then
            echo "❌ Prettier check failed: Code formatting issues detected"
            exit 1
          fi
          echo "✅ Prettier format check passed"

      - name: Run Vitest with Coverage
        run: |
          npm run test:coverage -- --run
          COVERAGE=$(npx c8 report --reporter=text-summary | grep "Statements" | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Test coverage below 80%: $COVERAGE%"
            exit 1
          fi
          echo "✅ All tests passed with coverage ≥ 80%"

      - name: Upload Frontend Coverage Report
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  quality-gate-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [backend-quality-gate, frontend-quality-gate]
    if: always()

    steps:
      - name: Check Quality Gate Status
        run: |
          if [ "${{ needs.backend-quality-gate.result }}" != "success" ] || [ "${{ needs.frontend-quality-gate.result }}" != "success" ]; then
            echo "❌ Quality Gate FAILED"
            echo "Backend: ${{ needs.backend-quality-gate.result }}"
            echo "Frontend: ${{ needs.frontend-quality-gate.result }}"
            exit 1
          fi
          echo "✅ Quality Gate PASSED - All checks successful!"
