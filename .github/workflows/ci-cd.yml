name: CI/CD Pipeline

# Quality Gate Mandatory Rules and Thresholds (Focus on "New Code")
#
# The Quality Gate (QG) must be configured to fail the build if any of the following
# thresholds are not met in the New Code (i.e., lines added or modified in this Pull Request).
#
# I. Reliability and Security (Zero Tolerance)
#
# Metric                        | Condition for Success  | Objective
# ------------------------------|------------------------|------------------------------------------
# New Bugs                      | Less than 1 (i.e., 0)  | No critical or major bugs introduced
# New Vulnerabilities           | Less than 1 (i.e., 0)  | No security vulnerabilities introduced
# New Security Hotspots         | Less than 1 (i.e., 0)  | Not applicable. These should be reviewed, not block the QG
#
# II. Maintainability and Code Quality
#
# Metric                        | Condition for Success  | Objective
# ------------------------------|------------------------|------------------------------------------
# New Code Smells               | Less than 1 (i.e., 0)  | Keep technical debt at zero for new code
# New Technical Debt Ratio      | Greater than 1.0       | Maintain maintainability
#                               | (or absent if not      |
#                               | using debt estimates)  |
# New Duplication Density       | Less than 3.0%         | Avoid introducing copied code
#
# III. Test Coverage
#
# Metric                        | Condition for Success  | Objective
# ------------------------------|------------------------|------------------------------------------
# New Code Coverage             | Greater than 80%       | All new lines of code must have high test coverage
#                               | (Ideal)                |
# New Condition Coverage        | Greater than 75%       | Ensure conditional branches are covered
#                               | (Ideal)                |
#
# Additional Note: By focusing on "New" metrics, we prevent quality degradation without
# blocking work due to historical debt in old code.

# Pipeline Architecture:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ PHASE 1: Quality Gate (Parallel)                                    â”‚
# â”‚   â”œâ”€ Backend: Pylint (9.0), MyPy (strict), Lizard (CCN â‰¤ 15)      â”‚
# â”‚   â””â”€ Frontend: ESLint, TypeScript, Prettier                        â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ PHASE 2: Tests & Coverage (Parallel, depends on Quality Gate)      â”‚
# â”‚   â”œâ”€ Backend: Pytest (â‰¥ 80% coverage)                              â”‚
# â”‚   â””â”€ Frontend: Vitest (â‰¥ 80% coverage)                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ PHASE 3: Build (Optional, disabled by default)                      â”‚
# â”‚   â”œâ”€ Backend: Docker image                                          â”‚
# â”‚   â””â”€ Frontend: Docker image                                         â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ PHASE 4: Deploy (Only on main/develop)                              â”‚
# â”‚   â””â”€ Deploy to Production (main) or Staging (develop)              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# To disable CI/CD: Set CI_ENABLED to 'false'
env:
  CI_ENABLED: "false"
  # Configuration
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22"
  PYLINT_THRESHOLD: 9.0
  COMPLEXITY_THRESHOLD: 15
  COVERAGE_THRESHOLD: 80

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ============================================================================
  # INITIALIZATION
  # ============================================================================
  check-ci:
    name: "ðŸ” Check CI Status"
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check if CI is enabled
        id: check
        run: echo "enabled=${{ env.CI_ENABLED }}" >> $GITHUB_OUTPUT

  # ============================================================================
  # PHASE 1: QUALITY GATE (Parallel Execution)
  # ============================================================================
  backend-quality-gate:
    name: "ðŸ”’ Backend Quality Gate"
    runs-on: ubuntu-latest
    needs: check-ci
    if: ${{ needs.check-ci.outputs.enabled == 'true' }}
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ Set up Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: "ðŸ“¦ Install Poetry"
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: "ðŸ“š Install dependencies"
        run: poetry install --no-interaction --no-ansi

      - name: "âœ¨ Pylint (PEP 8 Enforcement)"
        run: |
          poetry run pylint app/ --rcfile=.pylintrc --fail-under=${{ env.PYLINT_THRESHOLD }} --exit-zero > pylint-report.txt
          PYLINT_SCORE=$(poetry run pylint app/ --rcfile=.pylintrc --fail-under=${{ env.PYLINT_THRESHOLD }} | grep "Your code has been rated at" | awk '{print $7}' | cut -d'/' -f1)
          echo "Pylint Score: $PYLINT_SCORE"
          if (( $(echo "$PYLINT_SCORE < ${{ env.PYLINT_THRESHOLD }}" | bc -l) )); then
            echo "âŒ Pylint failed: Score $PYLINT_SCORE is below ${{ env.PYLINT_THRESHOLD }}"
            cat pylint-report.txt
            exit 1
          fi
          echo "âœ… Pylint passed with score: $PYLINT_SCORE"

      - name: "ðŸ” MyPy (Type Checking)"
        run: |
          poetry run mypy app/ --strict --pretty
          if [ $? -ne 0 ]; then
            echo "âŒ Mypy type checking failed: Type errors detected"
            exit 1
          fi
          echo "âœ… Mypy type checking passed (strict mode)"

      - name: "ðŸ§¬ Lizard (Complexity Check)"
        run: |
          poetry run lizard app/ -l python -C ${{ env.COMPLEXITY_THRESHOLD }} -w -o lizard-report.txt
          if [ $? -ne 0 ]; then
            echo "âŒ Lizard complexity check failed: Functions exceed CCN threshold of ${{ env.COMPLEXITY_THRESHOLD }}"
            cat lizard-report.txt
            exit 1
          fi
          echo "âœ… Lizard complexity check passed (CCN â‰¤ ${{ env.COMPLEXITY_THRESHOLD }})"

  frontend-quality-gate:
    name: "ðŸ”’ Frontend Quality Gate"
    runs-on: ubuntu-latest
    needs: check-ci
    if: ${{ needs.check-ci.outputs.enabled == 'true' }}
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ“¦ Set up Node.js ${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: "ðŸ“š Install dependencies"
        run: npm ci

      - name: "âœ¨ ESLint (Quality & Style Check)"
        run: |
          npm run lint -- --max-warnings=0
          if [ $? -ne 0 ]; then
            echo "âŒ ESLint failed: Critical errors or warnings found"
            exit 1
          fi
          echo "âœ… ESLint passed with zero errors/warnings"

      - name: "ðŸ” TypeScript Type Check"
        run: |
          npx tsc --noEmit --pretty
          if [ $? -ne 0 ]; then
            echo "âŒ TypeScript compilation failed: Type errors detected"
            exit 1
          fi
          echo "âœ… TypeScript type check passed"

      - name: "ðŸ’… Prettier Format Check"
        run: |
          npx prettier --check "**/*.{ts,tsx,js,jsx,json,css,md}"
          if [ $? -ne 0 ]; then
            echo "âŒ Prettier check failed: Code formatting issues detected"
            exit 1
          fi
          echo "âœ… Prettier format check passed"

  # ============================================================================
  # PHASE 2: TESTS & COVERAGE (Parallel Execution)
  # ============================================================================
  backend-tests:
    name: "ðŸ§ª Backend Tests & Coverage"
    runs-on: ubuntu-latest
    needs: [check-ci, backend-quality-gate]
    if: ${{ needs.check-ci.outputs.enabled == 'true' }}
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ Set up Python ${{ env.PYTHON_VERSION }}"
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ðŸ“¦ Install Poetry"
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: "ðŸ’¾ Load cached venv"
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('backend/poetry.lock') }}

      - name: "ðŸ“š Install dependencies"
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: "ðŸ“¦ Install project"
        run: poetry install --no-interaction

      - name: "ðŸ§ª Run tests with coverage"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-mock-key-for-ci' }}
        run: |
          poetry run pytest --cov=app --cov-report=xml --cov-report=term --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
          if [ $? -ne 0 ]; then
            echo "âŒ Tests failed or coverage below ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          fi
          echo "âœ… All tests passed with coverage â‰¥ ${{ env.COVERAGE_THRESHOLD }}%"

      - name: "ðŸ“Š Upload coverage to Codecov"
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  frontend-tests:
    name: "ðŸ§ª Frontend Tests & Coverage"
    runs-on: ubuntu-latest
    needs: [check-ci, frontend-quality-gate]
    if: ${{ needs.check-ci.outputs.enabled == 'true' }}
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ“¦ Set up Node.js ${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: "ðŸ“š Install dependencies"
        run: npm ci

      - name: "ðŸ§ª Run tests with coverage"
        run: |
          npm run test:coverage
          if [ $? -ne 0 ]; then
            echo "âŒ Tests failed or coverage below ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          fi
          echo "âœ… All tests passed with coverage â‰¥ ${{ env.COVERAGE_THRESHOLD }}%"

      - name: "ðŸ“Š Upload coverage to Codecov"
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage

      - name: "ðŸ—ï¸ Build application"
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8000/rag
        run: npm run build

  # ============================================================================
  # PHASE 3: BUILD (Optional - Disabled by default)
  # ============================================================================
  docker-build:
    name: "ðŸ³ Docker Build - ${{ matrix.service }}"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: false # Enable by changing to: ${{ needs.check-ci.outputs.enabled == 'true' }}
    strategy:
      matrix:
        service: [backend, frontend]

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ”§ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ðŸ³ Build ${{ matrix.service }} image"
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: false
          tags: document-hub-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # ============================================================================
  # PHASE 4: DEPLOY (Only on main/develop)
  # ============================================================================
  deploy:
    name: "ðŸš€ Deploy to ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}"
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: |
      needs.check-ci.outputs.enabled == 'true' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸš€ Deploy to ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}"
        run: |
          echo "ðŸš€ Deploying to ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}..."
          echo "ðŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ðŸ”– Commit: ${{ github.sha }}"

          # Add your deployment commands here
          # Examples:
          # - Railway: railway up
          # - Vercel: vercel --prod
          # - AWS: aws deploy ...
          # - Docker: docker-compose up -d
          # - Kubernetes: kubectl apply -f ...

          echo "âœ… Deployment completed successfully!"

  # ============================================================================
  # SUMMARY
  # ============================================================================
  ci-cd-summary:
    name: "ðŸ“Š Pipeline Summary"
    runs-on: ubuntu-latest
    needs:
      [
        backend-quality-gate,
        frontend-quality-gate,
        backend-tests,
        frontend-tests,
      ]
    if: always() && needs.check-ci.outputs.enabled == 'true'

    steps:
      - name: "ðŸ“Š Generate Pipeline Summary"
        run: |
          echo "# CI/CD Pipeline Results ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quality Gate & Tests Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Quality Gate | Backend (Pylint, MyPy, Lizard) | ${{ needs.backend-quality-gate.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Quality Gate | Frontend (ESLint, TypeScript, Prettier) | ${{ needs.frontend-quality-gate.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | Backend (Pytest â‰¥ ${{ env.COVERAGE_THRESHOLD }}%) | ${{ needs.backend-tests.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | Frontend (Vitest â‰¥ ${{ env.COVERAGE_THRESHOLD }}%) | ${{ needs.frontend-tests.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.backend-quality-gate.result }}" != "success" ] ||
             [ "${{ needs.frontend-quality-gate.result }}" != "success" ] ||
             [ "${{ needs.backend-tests.result }}" != "success" ] ||
             [ "${{ needs.frontend-tests.result }}" != "success" ]; then
            echo "## âŒ Pipeline Status: **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed jobs above and fix the issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "## âœ… Pipeline Status: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All quality checks and tests passed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
